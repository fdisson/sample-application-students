language: java
jdk: oraclejdk8
env:
  global:
  - secure: NYRfI6y1A+3eOaKPwH22bfDoKXbc5SChzesu8M3JToTz0QYWgIqsQEK39bp2FYXTZ8f3EO9aLwTWs8WRbj/6/lfQ4eiux8P4ROti0VUWx3It8EjatLnJkAwTBtao9JqnNMc8TL6ht3ZYUzCuJs0xiuUm3uQLrWFaCSZCctfpEj+Fg/9LG0CVSRB1mf5jj66e6l5t7MBtjBZCWzkEgb01hjRkYljsm0GHOeuNJa5JJQa1YIwt/CHxexSgdbmoTlhfyATw7T54OgEDEFttW+P/Wp0RQGEY1DOeoaL4VjI6kEPQEH9AUtmeJX/+fvA9c5i4r+p6p9PaudIB7ZjV985IVq/tCWBTIbPf8C8w7XaoFkWKD+VrRkhQ03dC0X7hrOYpRsf1m+tO44RZcLpdPZSdf6kG6O+tXff66RNTJko3nZrocHSAJSSjdc+AWVe6h1Hn5EkqA6K8/sxPyTPMbDhioUBj7hqpHOSuMRjDKz4ACnM04e8KxzFesNjdn9LFH/CfDChmKvkBn/KlXo4um3cGhBKivH9NsYbDI1CnRcYDA2Shs2gkUsZ8D4z5pygQ7IZgMK2BYXKnYnJBz5hEPc0fMIddtgKOhm1GOI4m33buL2dJVOn3VTLUgeJbbJK+z35cKPHUM4f0/HT6OjsnkqaSSloOJdhYGlaoCm5YnArwCYY=
  - secure: boxxDsDJvfK2JtP+wYv0HH5D7a+23XZw13JNP8ru+oSE1rWDdXbZI3ZEj720wLu5z2j6MqLk54qiCOFNbQG+M26ytl2hMbxM1fSYZ3dV4nG8bTLXiE9RMiFreIrNLBvi933IBtngDrirQEzrEzz+ta1O3yUouYmUfamnB9i6ANCZktVnmF+TBovIjzbNPjVG5dXpEjReeJDHHcH8VildJh6geikv7qVz8PGFW+snjtQXJ1yEbQw8jqHw3X4erpeu0CuWLG/pafefEX0eIgUatZronZGo2zblILl6e/saJBAkQS3dSIT8jlfgqcZvSd6eNTYlQrXZ4SKnUfQzK1kl2xf0d5hzpqiLmWTCtYJPy52w8qPwCaRUrcSjdDrvfwcE7vT894kg+MSs5+UDMa4hl7c4VPN0LRy1sVxcE7U5F/fZ+ZwC5iKloEnLg6W8mCfXijOocS6+gI0efJmXfsd+oEI1xXBuX/0Mf/8SWjaxIruZKkEhVOrYyGH0QHu+ltzm3c2phSu3QRO4a3FqtGFNu5R0yfP8q8ZKE6EeMwH3Eo87vANDgEMPf67liQtubRgW1sOl7CyELAb+BGGpe9+DYGRjGmmyaPgFVQz3fsoRpcPnmV9Mkcf6PnPvjMBxamWwJrLc0XCjOXwMy7SHpPZGAe7/sDIkx8SDq0v73pmsSRI=
  - secure: pq9BgpBl4DP4kWKm946N87MDo+WBDh4g5oZAVE2tX1oJbt/4zoNUjH0ilHJOAMyCuMP+zdfbWbYOY/v+lj2hE6162Wv9q8HKwTM+Y6p1YABdIvqtHSbIjAR6KYAk/9z357izc5bNNb+3FenMIEQphr7PEGbWab+CgZLKHpFdGkDfSTUh9YxkwwGTZ1XkLt6aMKWRPYK1jxp2H/rDHZosalVwpdeIRST44Z4x01BROHJw11E24uHXglNPhME00TsSaikN5/TYvwEsnBky0EM2DiG+Bsm24itOokuXSbTrUJgcKyvG3CskjCVGYUYV9znd2KJZszfhz3I8W0hMLVe/BD68fseT/4E5qPZRTDFHv75+x/RBJn5ISP4VFNfFoE7r2jrgR8JiM3MFzN2s1xe0Ta803wcPhlfj0pdjZwOJzesrfc8G1CgVS7ILsL9ZdRza22WsyHtvTNXNjpr/RJcWc7g47YBMYLwLpjps2w9dlXXlpUNo5RPCwM2Kse1+jFbEparnRZnkF5nhALTYEKybssg0pEnUZEzTveT2Tu9YMvEbiR2YgpB+cArxSDT7FbDHkV9jf08ERIiP6OC/vu3f5aNC2nooYWO2yzbggRPEDmucbNdRQvN/YfT7Jpi0EkUSW8uf9SybdttX92XvXQNr8Jkw6iVPrRByGbksd4G3D1s=
  - secure: FeE5pW7VE9Iu/QahHcBSJe/vBFalQ2uZaqFEJvEaZNH7XmdQtKAeur8aUYgpPtbTOAUe/AnWEZc43VErvO6UHT+Px3pjiIi5geUnDM11nb8NmcVIrDRO51AZcAHA9RqwuqlehOC0K0dvmwy5pvy5gnWgNyCIE6gmYoiekHAsQPg8GZXOX8KnrUxZMMq85tr/agr1xS7xEKp/VHfSX3Bxm2cyfD8VV0iA7tFcovDyt47uc+TJAEDF3JFgTcVmDP25ff8k2PSeTPXvUn7sqo4c9cxwY4W1WVhbLFCXOVYj2GVx9kl13ZrE11z9gLACahdqkJKT20D6DZWkYYf4/GVrn5i/XEKzzIyKgbALB0ZBZSaz6ctgD/IT5ibwc9lS3fFpoCYgmWSqDcx0F/jjcTPojT44SAlgq8UFz0ITPI8CafHFNVjG6QgYX5/9jS5MzL6OIg5Z+ZaQda0N4lcvb8vR5gMby1Yc2s68FoIRDCu6M+dGjTqT6EYrwxr9Qv6Rdsn0fKTZT5AYRMcBVf6uwVTOuJuS0KdIjuZPuViYuZ1GAFqCt9c1/XJLQ5rrVbXgbS3u/sjU/UYBqHR18YEjBNN0Fl4c44YrAU2P7u2zAKTesjPqkDh8NZSonTsPGoA2NGqX0nn9WLKfY5QZuGaPHdnpQEHPSX0KBIILd5cN6N1PDsE=
  - secure: UYX6ZPv6Uv56ny3l9YDmforDirtTnRUMUr/SD5FGgGG/PRJYADHu/qm/JRtqxXB/r1xiNZsISQdkQmFcNp4FzS7TarC7qA++knidyJqZCGXaT447R72CIH4ntSb3RPBMS2FZNOu0LZhksBe6H7P8VyoY22uPfD7iKQ0cmwPxDkdj9wm+PekoFGcAxLgjlkmBiVjnL9FVyHp8PtoQvoRrCGtZ09lN0/afRzM+qmliebdIqlpQAmPfXTY9YqAFLHt5G0I8/fwucI4Bo/kgJetuB+nS65ldviL4HZAkCrFiehq5lx46nauXbJ73a7WiCaHKevHf1cFPTPNsJDCqBx1nC8VoCYutQJCXbPOUduLXVYL71zVTMBlchwchrnDfBXUk6VRb4db1f/Uo2gNKB9UhMaMrnNTqNPpjn9lRfi/AKsvOZescKFAMXKLPeDcdg4eYAt+Z7bSnI0Zx27vkPYiIY452O3Vcqj9Wf4ZJXHEgXDZFXRrraaSSZKUc6+x6jbN53nzr16zLLh7hRTB8J/Q06h3jrpQOtY2YHtSXgyV4mYem5TAdauRTnl3wAHIOG34P9t+VqlO6xzpnbFIMt2apCeyahTuEbm1f/4nO+dAtJxZOwIU7NZVl5BKObRKzzEWexxgM4xBsbzxZIcxJo3x1UYrDOFUKPr/vF9PBO2JW1Lc=
services:
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_4c37e285a959_key -iv $encrypted_4c37e285a959_iv -in travis_deploy_rsa.enc -out /tmp/travis_deploy_rsa -d
- sudo service mysql stop
- docker pull takimatraining/devops-training-db
- docker run -d -p 127.0.0.1:3306:3306 takimatraining/devops-training-db
- chmod 600 /tmp/travis_deploy_rsa
- eval "$(ssh-agent -s)"
- ssh-add /tmp/travis_deploy_rsa
- echo -e "Host $SERVER_IP_ADDRESS\n\tStrictHostKeyChecking no\n" >> ~/.ssh/config
script:
- |
  mvn clean install sonar:sonar \
    -Dsonar.projectKey=fdisson_sample-application-students \
    -Dsonar.organization=fdisson-github \
    -Dsonar.host.url=https://sonarcloud.io \
    -Dsonar.login=$SONAR_TOKEN
cache:
  directories:
  - "$HOME/.m2/repository"
after_success:
- docker login -u $DOCKER_USER -p $DOCKER_PASS
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $TRAVIS_BRANCH;
  fi`
- export IMAGE_NAME=fdisson/sample-application
- docker build -t $IMAGE_NAME:$TRAVIS_COMMIT .
- docker tag $IMAGE_NAME:$TRAVIS_COMMIT $IMAGE_NAME:$TAG
- docker push $IMAGE_NAME:$TAG
deploy:
  provider: script
  script: ssh -i /tmp/travis_deploy_rsa $DEPLOY_USER@$SERVER_IP_ADDRESS "sudo docker
    pull $IMAGE_NAME:$TAG && sudo docker rm -f app || true && sudo docker run -d --network
    net -p 80:8080 --name app $IMAGE_NAME:$TAG"
  on:
    branch: master
